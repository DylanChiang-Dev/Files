# Personal Build Workflow
# 用于个人设备安装的简化打包流程，使用自签名证书

name: Build Personal (Self-Signed)

on:
  workflow_dispatch:
    inputs:
      platform:
        description: '打包平台'
        required: true
        default: 'x64'
        type: choice
        options:
          - x64
          - arm64
          - x64|arm64

jobs:
  build:
    runs-on: windows-latest
    env:
      SOLUTION_NAME:           'Files.slnx'
      CONFIGURATION:           'Release'
      PLATFORM:                'x64'
      APPX_BUNDLE_PLATFORMS:   '${{ github.event.inputs.platform }}'
      WORKING_DIR:             '${{ github.workspace }}'
      ARTIFACTS_STAGING_DIR:   '${{ github.workspace }}\artifacts'
      APPX_PACKAGE_DIR:        '${{ github.workspace }}\artifacts\AppxPackages'
      PACKAGE_PROJECT_DIR:     'src\Files.App (Package)'
      PACKAGE_PROJECT_PATH:    'src\Files.App (Package)\Files.Package.wapproj'
      PACKAGE_MANIFEST_PATH:   'src\Files.App (Package)\Package.appxmanifest'
      LAUNCHER_PROJECT_PATH:   'src\Files.App.Launcher\Files.App.Launcher.vcxproj'
      # 自签名证书发布者 (可自定义)
      SELF_SIGN_PUBLISHER:     'CN=Files Personal Build'

    steps:
    - name: Checkout the repository
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        global-json-file: global.json

    - name: Generate self-signed certificate
      shell: pwsh
      run: |
        $cert = New-SelfSignedCertificate `
          -Type Custom `
          -Subject "$env:SELF_SIGN_PUBLISHER" `
          -KeyUsage DigitalSignature `
          -FriendlyName "Files Personal Build Certificate" `
          -CertStoreLocation "Cert:\CurrentUser\My" `
          -TextExtension @("2.5.29.37={text}1.3.6.1.5.5.7.3.3", "2.5.29.19={text}")
        
        # 导出证书供用户安装
        $certPath = "$env:ARTIFACTS_STAGING_DIR\FilesPersonalBuild.cer"
        New-Item -ItemType Directory -Force -Path $env:ARTIFACTS_STAGING_DIR
        Export-Certificate -Cert $cert -FilePath $certPath
        
        # 保存证书指纹
        echo "CERT_THUMBPRINT=$($cert.Thumbprint)" >> $env:GITHUB_ENV
        Write-Host "Certificate generated with thumbprint: $($cert.Thumbprint)"

    - name: Configure package manifest for personal build
      shell: pwsh
      run: |
        # 更新 Package.appxmanifest 中的 Publisher
        [xml]$manifest = Get-Content $env:PACKAGE_MANIFEST_PATH
        $manifest.Package.Identity.Publisher = $env:SELF_SIGN_PUBLISHER
        $manifest.Package.Identity.Name = "FilesPersonal"
        $manifest.Package.Properties.DisplayName = "Files (Personal)"
        $manifest.Package.Applications.Application.VisualElements.DisplayName = "Files (Personal)"
        $manifest.Save($env:PACKAGE_MANIFEST_PATH)
        
        # 更新应用图标路径（使用 Release 图标）
        Get-ChildItem $env:WORKING_DIR -Include *.csproj, *.appxmanifest, *.wapproj, *.xaml -Recurse | ForEach-Object {
          (Get-Content $_ -Raw) -replace "Assets\\AppTiles\\Dev", "Assets\AppTiles\Release" | Set-Content $_ -NoNewline
        }
        
        # 替换占位符（使用空值，这些功能在个人版中不可用）
        Get-ChildItem $env:WORKING_DIR -Include *.cs -Recurse | ForEach-Object {
          $content = Get-Content $_ -Raw
          $content = $content -replace "cd_app_env_placeholder", "SideloadStable"
          $content = $content -replace "bingmapskey.secret", ""
          $content = $content -replace "sentry.secret", ""
          $content = $content -replace "githubclientid.secret", ""
          $content | Set-Content $_ -NoNewline
        }

    - name: Use Windows SDK Preview
      shell: cmd
      run: |
        for /f %%a in ('dir /b /a:d %localappdata%\Microsoft\VisualStudio\17*') do echo UsePreviews=True>%localappdata%\Microsoft\VisualStudio\%%a\sdk.txt

    - name: Restore Files
      shell: pwsh
      run: |
        msbuild $env:SOLUTION_NAME `
          -t:Restore `
          -p:Platform=$env:PLATFORM `
          -p:Configuration=$env:CONFIGURATION `
          -p:PublishReadyToRun=true

    - name: Restore NuGet for Launcher
      shell: pwsh
      run: |
        nuget restore "$env:LAUNCHER_PROJECT_PATH" `
          -SolutionDirectory "$env:WORKING_DIR"

    - name: Build Launcher
      shell: pwsh
      run: |
        msbuild "$env:LAUNCHER_PROJECT_PATH" `
          -t:Build `
          -p:Platform=$env:PLATFORM `
          -p:Configuration=$env:CONFIGURATION

    - name: Build & Package Files
      shell: pwsh
      run: |
        msbuild "$env:PACKAGE_PROJECT_PATH" `
          -t:Build `
          -t:_GenerateAppxPackage `
          -p:Platform=$env:PLATFORM `
          -p:Configuration=$env:CONFIGURATION `
          -p:AppxBundlePlatforms=$env:APPX_BUNDLE_PLATFORMS `
          -p:AppxPackageDir="$env:APPX_PACKAGE_DIR" `
          -p:AppxBundle=Always `
          -p:UapAppxPackageBuildMode=Sideload `
          -p:GenerateAppInstallerFile=False `
          -p:AppxPackageSigningEnabled=True `
          -p:PackageCertificateThumbprint=$env:CERT_THUMBPRINT

    - name: Create installation instructions
      shell: pwsh
      run: |
        $instructions = @"
        # Files Personal Build 安装说明
        
        ## 安装步骤
        
        ### 1. 安装证书（只需首次安装）
        1. 双击 `FilesPersonalBuild.cer` 文件
        2. 点击「安装证书」
        3. 选择「本地计算机」，点击下一步（需要管理员权限）
        4. 选择「将所有证书放入下列存储」
        5. 点击「浏览」，选择「受信任的根证书颁发机构」
        6. 点击确定，完成证书安装
        
        ### 2. 安装应用
        1. 进入 `AppxPackages` 文件夹
        2. 找到 `.msixbundle` 文件，双击安装
        
        ## 注意事项
        - 证书只需在每台电脑上安装一次
        - 每次更新应用时，直接安装新的 .msixbundle 即可
        - 此版本为个人构建，部分功能（Bing Maps、GitHub 登录等）不可用
        
        ## 卸载
        在 Windows 设置 > 应用 中找到「Files (Personal)」并卸载
        "@
        
        $instructions | Out-File -FilePath "$env:ARTIFACTS_STAGING_DIR\安装说明.txt" -Encoding UTF8

    - name: Remove empty files
      shell: bash
      run: find $ARTIFACTS_STAGING_DIR -empty -delete

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: 'Files-Personal-Build-${{ github.event.inputs.platform }}'
        path: ${{ env.ARTIFACTS_STAGING_DIR }}
        retention-days: 30
